<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roti Canai Order</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; padding: 20px; max-width: 500px; margin: 0 auto; }
        h1 { text-align: center; color: #d35400; margin-bottom: 10px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { text-align: center; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; font-size: 16px; }
        .available { background: #d4edda; color: #155724; }
        .soldout { background: #f8d7da; color: #721c24; }
        label { display: block; margin: 15px 0 5px; font-weight: 600; color: #333; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        input:focus, select:focus { outline: none; border-color: #d35400; }
        .addon { background: #f8f8f8; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .addon label { display: flex; justify-content: space-between; margin: 8px 0; font-weight: normal; cursor: pointer; }
        .addon input { width: auto; margin-right: 10px; }
        .total { font-size: 26px; text-align: right; color: #d35400; font-weight: bold; margin: 20px 0; padding: 15px; background: #fff5f0; border-radius: 8px; }
        .btn { background: #27ae60; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: #219a52; }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; }
        .hidden { display: none; }
        #debug { background: #1a1a1a; color: #00ff00; padding: 15px; font-size: 12px; margin-top: 20px; border-radius: 8px; max-height: 200px; overflow-y: auto; font-family: monospace; }
        .info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; color: #1565c0; }
    </style>
</head>
<body>

    <h1>ü•û Roti Canai Express</h1>
    
    <div class="info">
        <strong>üì¶ Today's Menu:</strong><br>
        ‚Ä¢ OriPack - 150p (2 Roti + Sauce)<br>
        ‚Ä¢ Kawen Pack - 200p (1 Roti + 1 Egg + Sauce)<br>
        ‚Ä¢ Add-ons available below
    </div>
    
    <div id="status" class="status">‚è≥ Checking stock...</div>
    
    <div id="form-container" class="card hidden">
        <label>üìõ Your Name</label>
        <input type="text" id="name" placeholder="Enter your name">
        
        <label>üö™ Room Number</label>
        <input type="text" id="room" placeholder="e.g., A-101">
        
        <label>üì± Phone Number</label>
        <input type="tel" id="phone" placeholder="e.g., 0123456789">
        
        <label>üçΩÔ∏è Select Pack</label>
        <select id="pack" onchange="calc()">
            <option value="0" disabled selected>-- Choose Your Pack --</option>
            <option value="150">OriPack - 150p (2 Roti + Sauce)</option>
            <option value="200">Kawen Pack - 200p (1 Roti + 1 Egg + Sauce)</option>
        </select>
        
        <div class="addon">
            <label style="margin-top:0; font-weight:600;">‚ûï Add Ons</label>
            <label><span><input type="checkbox" id="ar" value="50" onchange="calc()"> Extra Roti</span> <span>+50p</span></label>
            <label><span><input type="checkbox" id="ae" value="100" onchange="calc()"> Extra Egg</span> <span>+100p</span></label>
            <label><span><input type="checkbox" id="as" value="50" onchange="calc()"> Extra Sauce</span> <span>+50p</span></label>
        </div>
        
        <div class="total">üí∞ Total: <span id="tot">0</span>p</div>
        
        <button class="btn" id="btn" onclick="submit()">üõí Order & Pay</button>
    </div>
    
    <div id="soldout" class="card hidden" style="text-align:center;">
        <h2 style="color:#c0392b; margin-bottom:10px;">‚õî SOLD OUT</h2>
        <p style="color:#666;">We have reached our limit of 50 orders for today.</p>
        <p style="color:#666;">Please check back tomorrow!</p>
    </div>
    
    <div id="debug" class="hidden"></div>

    <script>
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è REPLACE THESE TWO VALUES ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbys2YfCWQnVT0ZOgmzJMZ2sBIASwJ5E3cAV7L5dbcyyCPl6ZpS2woZ1n3YrOswwmDr1/exec";
        const YOOMONEY = "4100119475590040";
        // Example: const YOOMONEY = "410011234567890";
        
        function log(msg) {
            const d = document.getElementById('debug');
            d.classList.remove('hidden');
            const time = new Date().toLocaleTimeString();
            d.innerHTML += `<div>[${time}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
            console.log(msg);
        }
        
        window.onload = function() {
            log('Page loaded. Checking stock...');
            
            if(SCRIPT_URL === "PASTE_YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") {
                log('‚ö†Ô∏è ERROR: You need to add your Google Script URL!');
                document.getElementById('status').innerText = '‚ö†Ô∏è Configuration Error - Contact Admin';
                return;
            }
            
            fetch(SCRIPT_URL)
                .then(r => {
                    log('Stock response status: ' + r.status);
                    return r.json();
                })
                .then(data => {
                    log('Stock data: ' + JSON.stringify(data));
                    if(data.available > 0) {
                        document.getElementById('status').className = 'status available';
                        document.getElementById('status').innerText = 'üî• Only ' + data.available + ' packs left!';
                        document.getElementById('form-container').classList.remove('hidden');
                    } else {
                        document.getElementById('status').className = 'status soldout';
                        document.getElementById('status').innerText = '‚ùå Sold Out';
                        document.getElementById('soldout').classList.remove('hidden');
                    }
                })
                .catch(err => {
                    log('‚ùå Fetch error: ' + err);
                    document.getElementById('status').className = 'status soldout';
                    document.getElementById('status').innerText = '‚ö†Ô∏è Connection Error';
                });
        };
        
        function calc() {
            let t = parseInt(document.getElementById('pack').value);
            if(document.getElementById('ar').checked) t += 50;
            if(document.getElementById('ae').checked) t += 100;
            if(document.getElementById('as').checked) t += 50;
            document.getElementById('tot').innerText = t;
            return t;
        }
        
        function submit() {
            const name = document.getElementById('name').value.trim();
            const room = document.getElementById('room').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const pack = document.getElementById('pack').value;
            const total = calc();
            
            log('Form data - Name: ' + name + ', Room: ' + room + ', Total: ' + total);
            
            if(!name || !room || !phone) {
                alert('‚ö†Ô∏è Please fill in all fields!');
                return;
            }
            
            if(total == 0) {
                alert('‚ö†Ô∏è Please select a pack!');
                return;
            }
            
            const btn = document.getElementById('btn');
            btn.disabled = true;
            btn.innerText = '‚è≥ Processing...';
            log('Submitting order to Google Sheet...');
            
            let addons = [];
            if(document.getElementById('ar').checked) addons.push('Extra Roti');
            if(document.getElementById('ae').checked) addons.push('Extra Egg');
            if(document.getElementById('as').checked) addons.push('Extra Sauce');
            
            const packText = document.getElementById('pack').options[document.getElementById('pack').selectedIndex].text;
            const details = packText + (addons.length ? ' + ' + addons.join(', ') : '');
            
            log('Order details: ' + details);
            
            const formData = new FormData();
            formData.append('name', name);
            formData.append('room', room);
            formData.append('phone', phone);
            formData.append('orderDetails', details);
            formData.append('totalPrice', total);
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(r => {
                log('Response status: ' + r.status);
                return r.json();
            })
            .then(data => {
                log('Server response: ' + JSON.stringify(data));
                if(data.result === 'success') {
                    log('‚úÖ Order saved! Redirecting to Yoomoney...');
                    
                    // Create Yoomoney payment form (official API)
                    var form = document.createElement('form');
                    form.method = 'POST';
                    form.action = 'https://yoomoney.ru/quickpay/confirm.xml';
                    
                    var fields = {
                        'receiver': YOOMONEY,
                        'quickpay': 'form',
                        'account': YOOMONEY,
                        'sum': total,
                        'paymentType': 'AC',
                        'targets': 'Roti Canai - Room ' + room,
                        'label': room
                    };
                    
                    for(var key in fields) {
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = fields[key];
                        form.appendChild(input);
                    }
                    
                    document.body.appendChild(form);
                    log('üì§ Submitting payment form to Yoomoney...');
                    form.submit();
                    
                } else {
                    log('‚ùå Order failed: ' + data.message);
                    alert('‚ùå Error: ' + (data.message || 'Failed to place order. Please try again!'));
                    btn.disabled = false;
                    btn.innerText = 'üõí Order & Pay';
                }
            })
            .catch(err => {
                log('‚ùå Network error: ' + err);
                alert('‚ö†Ô∏è Network error. Please check your connection and try again.');
                btn.disabled = false;
                btn.innerText = 'üõí Order & Pay';
            });
        }
    </script>
</body>
</html>