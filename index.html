<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roti Canai Order</title>
    <style>
        body { font-family: sans-serif; background: #f5f5f5; padding: 20px; max-width: 500px; margin: 0 auto; }
        h1 { text-align: center; color: #d35400; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .status { text-align: center; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-weight: bold; }
        .available { background: #d4edda; color: #155724; }
        .soldout { background: #f8d7da; color: #721c24; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .addon { background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .addon label { display: flex; justify-content: space-between; margin: 5px 0; font-weight: normal; }
        .total { font-size: 24px; text-align: right; color: #d35400; font-weight: bold; margin: 15px 0; }
        .btn { background: #27ae60; color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-size: 18px; cursor: pointer; }
        .btn:disabled { background: #95a5a6; }
        .hidden { display: none; }
        #debug { background: #333; color: #0f0; padding: 10px; font-size: 12px; margin-top: 20px; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>ü•û Roti Canai</h1>
    
    <div id="status" class="status">Loading...</div>
    
    <div id="form-container" class="card hidden">
        <label>Name</label>
        <input type="text" id="name" placeholder="Your name">
        
        <label>Room Number</label>
        <input type="text" id="room" placeholder="A-101">
        
        <label>Phone</label>
        <input type="tel" id="phone" placeholder="0123456789">
        
        <label>Pack</label>
        <select id="pack" onchange="calc()">
            <option value="0">-- Select --</option>
            <option value="150">OriPack (2 Roti + Sauce) - 150p</option>
            <option value="200">Kawen Pack (1 Roti + 1 Egg + Sauce) - 200p</option>
        </select>
        
        <div class="addon">
            <label><span><input type="checkbox" id="ar" value="50" onchange="calc()"> Extra Roti</span> <span>+50p</span></label>
            <label><span><input type="checkbox" id="ae" value="100" onchange="calc()"> Extra Egg</span> <span>+100p</span></label>
            <label><span><input type="checkbox" id="as" value="50" onchange="calc()"> Extra Sauce</span> <span>+50p</span></label>
        </div>
        
        <div class="total">Total: <span id="tot">0</span>p</div>
        
        <button class="btn" id="btn" onclick="submit()">Order & Pay</button>
    </div>
    
    <div id="soldout" class="card hidden" style="text-align:center;">
        <h2 style="color:red;">‚õî SOLD OUT</h2>
        <p>Come back tomorrow!</p>
    </div>
    
    <div id="debug" class="hidden"></div>

    <script>
        // ‚ö†Ô∏è REPLACE THIS WITH YOUR WEB APP URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbys2YfCWQnVT0ZOgmzJMZ2sBIASwJ5E3cAV7L5dbcyyCPl6ZpS2woZ1n3YrOswwmDr1/exec";
        const YOOMONEY = "4100119475590040";
        
        function log(msg) {
            const d = document.getElementById('debug');
            d.classList.remove('hidden');
            d.innerHTML += '<br>' + msg;
            console.log(msg);
        }
        
        window.onload = function() {
            log('Checking stock...');
            fetch(SCRIPT_URL)
                .then(r => r.json())
                .then(data => {
                    log('Stock response: ' + JSON.stringify(data));
                    if(data.available > 0) {
                        document.getElementById('status').className = 'status available';
                        document.getElementById('status').innerText = 'üî• ' + data.available + ' packs left!';
                        document.getElementById('form-container').classList.remove('hidden');
                    } else {
                        document.getElementById('status').className = 'status soldout';
                        document.getElementById('status').innerText = 'Sold Out';
                        document.getElementById('soldout').classList.remove('hidden');
                    }
                })
                .catch(err => {
                    log('Error: ' + err);
                    document.getElementById('status').innerText = 'Connection Error';
                });
        };
        
        function calc() {
            let t = parseInt(document.getElementById('pack').value);
            if(document.getElementById('ar').checked) t += 50;
            if(document.getElementById('ae').checked) t += 100;
            if(document.getElementById('as').checked) t += 50;
            document.getElementById('tot').innerText = t;
            return t;
        }
        
        function submit() {
            const name = document.getElementById('name').value;
            const room = document.getElementById('room').value;
            const phone = document.getElementById('phone').value;
            const pack = document.getElementById('pack').value;
            const total = calc();
            
            if(!name || !room || !phone || total == 0) {
                alert('Fill all fields!');
                return;
            }
            
            const btn = document.getElementById('btn');
            btn.disabled = true;
            btn.innerText = 'Processing...';
            log('Submitting order...');
            
            let addons = [];
            if(document.getElementById('ar').checked) addons.push('Roti');
            if(document.getElementById('ae').checked) addons.push('Egg');
            if(document.getElementById('as').checked) addons.push('Sauce');
            
            const packText = document.getElementById('pack').options[document.getElementById('pack').selectedIndex].text;
            const details = packText + (addons.length ? ' + ' + addons.join(', ') : '');
            
            // Use form data instead of JSON to avoid CORS issues
            const formData = new FormData();
            formData.append('name', name);
            formData.append('room', room);
            formData.append('phone', phone);
            formData.append('orderDetails', details);
            formData.append('totalPrice', total);
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                log('Response: ' + JSON.stringify(data));
                if(data.result === 'success') {
                    log('Success! Redirecting to payment...');
                    window.location.href = 'https://yoomoney.ru/quickpay/confirm.xml?receiver=' + YOOMONEY + '&quickpay=form&sum=' + total + '&targets=Roti-' + room;
                } else {
                    alert('Error: ' + (data.message || 'Failed'));
                    log('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerText = 'Order & Pay';
                }
            })
            .catch(err => {
                log('Fetch error: ' + err);
                alert('Network error. Check console.');
                btn.disabled = false;
                btn.innerText = 'Order & Pay';
            });
        }
    </script>
</body>
</html>
